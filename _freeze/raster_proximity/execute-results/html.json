{
  "hash": "d591ac31c39706adf8c6c59379290bdc",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"근접성 분석\"\nauthor: Sang-Il Lee\ndate-modified: last-modified\nnumber-sections: true\nformat: \n  html: \n    toc: true\ncode-link: true\ncode-copy: true\nlightbox: true\nexecute: \n  warning: false\n  error: false\n  freeze: auto\neditor: visual\neditor_options: \n  chunk_output_type: console\n---\n\n\n## 준비\n\n필수적인 패키지를 설치한다. 래스터 분석을 위한 기본 패키지를 `terra`를 사용한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(terra)\nlibrary(sf)\nlibrary(tmap)\n```\n:::\n\n\n서울에 대한 SRTM 기반 DEM 데이터를 불러온다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndem_seoul <- rast(\"D:/My R/World Data Manupulation/USGS EarthExplorer/srtm_seoul.tif\")\ndem_seoul_mask <- rast(\"D:/My R/World Data Manupulation/USGS EarthExplorer/srtm_seoul_mask.tif\")\n```\n:::\n\n\n서울의 행정구역 바운더리 파일을 불러온다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseoul <- st_read(\"D:/My R/Korean Administrative Areas/행정구역 셰이프 파일/2 Original Cleaning/2023_2Q/SEOUL_SIDO_2023_2Q.shp\")\nseoul_gu <- st_read(\"D:/My R/Korean Administrative Areas/행정구역 셰이프 파일/2 Original Cleaning/2023_2Q/SEOUL_GU_2023_2Q.shp\")\nseoul_dong <- st_read(\"D:/My R/Korean Administrative Areas/행정구역 셰이프 파일/2 Original Cleaning/2023_2Q/SEOUL_EMD_2023_2Q.shp\")\n```\n:::\n\n\n서울의 소방서 위치를 불러온다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseoul_sobang <- st_read(\"D:/My R/Vector Data Manipulation Korea/Seoul_Data_Plaza/sobang_station_seoul.shp\", options = \"ENCODING=CP949\")\nseoul_sobang <- st_transform(seoul_sobang, crs = st_crs(seoul))\n```\n:::\n\n\n## 정의와 산출 레이어\n\n## 유클리드 거리\n\n### 거리\n\n소방서로부터의 유클리드 거리를 계산한다. `distance()` 함수에서 첫 번째 인수가 raster이면 모든 NA셀(소방서가 없는 셀)로부터 비NA 셀(소방서가 위치한 셀) 중 가장 가까이 있는 것까지의 거리를 계산해준다. 첫 번째 인수가 vector이면 모든 피처간의 거리 매트릭스를 산출해 준다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseoul_sobang |> \n  rasterize(dem_seoul, field = \"ID\") -> seoul_sobang_r\nseoul_sobang_r |> \n  distance() / 1000 -> seoul_sobang_dist_1\nseoul_sobang_dist_1 |> \n  mask(seoul) -> seoul_sobang_dist_1_mask\n```\n:::\n\n\n지도를 제작한다. 먼저 연속형 컬러 스킴을 사용하여 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(seoul_sobang_dist_1_mask, raster.downsample = FALSE) + tm_raster(style = \"cont\", palette = \"GnBu\", title = \"Distance(km)\") +\n  tm_shape(seoul_sobang) + tm_symbols() +\n  tm_shape(seoul) + tm_borders(col = \"gray20\", lwd = 1.5) +\n  tm_legend(legend.position = c(0.85, 0.03), legend.bg.color = \"white\", legend.bg.alpha = 0.6) +\n  tm_layout(inner.margins = c(0.06, 0.04, 0.04, 0.04), \n            title = \"Euclidean Distance from Fire Stations\", title.size = 1, \n            title.position = c(\"LEFT\", \"TOP\")) + \n  tm_scale_bar(breaks = seq(0, 20, 4), color.dark = \"gray60\", position = c(0.03, 0.01))\nmy_map\n```\n\n::: {.cell-output-display}\n![](raster_proximity_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n이번에는 단계구분형 컬러 스킴을 사용하여 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(seoul_sobang_dist_1_mask, raster.downsample = FALSE) + tm_raster(style = \"fixed\", breaks = c(0, 1, 2, 3, 4, 5, Inf), palette = \"GnBu\", title = \"Distance(km)\") +\n  tm_shape(seoul_sobang) + tm_symbols() +\n  tm_shape(seoul) + tm_borders(col = \"gray20\", lwd = 1.5) +\n  tm_legend(legend.position = c(0.85, 0.03), legend.bg.color = \"white\", legend.bg.alpha = 0.6) +\n  tm_layout(inner.margins = c(0.06, 0.04, 0.04, 0.04), \n            title = \"Euclidean Distance from Fire Stations\", title.size = 1, \n            title.position = c(\"LEFT\", \"TOP\")) + \n  tm_scale_bar(breaks = seq(0, 20, 4), color.dark = \"gray60\", position = c(0.03, 0.01))\nmy_map\n```\n\n::: {.cell-output-display}\n![](raster_proximity_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n### 할당\n\n함수를 만든다. `raster` 패키지의 `rasterToPoints()` 함수가 `terra` 패키지에서는 `as.points()` 함수로 바뀌었다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# snu.rasterAlloc <- function(feature, rastermask){\n#   p <- st_as_sf(as.points(rastermask))\n#   p <- st_transform(p, crs = st_crs(feature))\n#   p$indx <- st_nearest_feature(st_geometry(p), st_geometry(feature))\n#   output <- rasterize(p, rastermask, field = \"indx\")\n#   return(output)\n# }\n\nsnu.rasterAlloc <- function(feature, rastermask){\n  rastermask |> \n    as.points() |> \n    st_as_sf() |> \n    st_transform(crs = st_crs(feature)) -> p\n  p |> \n    st_geometry() |> \n    st_nearest_feature(st_geometry(feature)) -> p_index\n  p |> \n    mutate(\n      index = p_index\n    ) |> \n    rasterize(rastermask, field = \"index\") -> output\n  return(output)\n}\n```\n:::\n\n\n할당면을 생성한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseoul_sobang |> \n  snu.rasterAlloc(dem_seoul_mask) -> seoul_sobang_allo\n```\n:::\n\n\n지도를 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(seoul_sobang_allo, raster.downsample = FALSE) + tm_raster(style = \"cat\", palette = \"Set3\", legend.show = FALSE) +\n  tm_shape(seoul_sobang) + tm_symbols() +\n  tm_shape(seoul) + tm_borders(col = \"gray20\", lwd = 1.5) +\n  tm_legend(legend.position = c(0.85, 0.03), legend.bg.color = \"white\", legend.bg.alpha = 0.6) +\n  tm_layout(inner.margins = c(0.06, 0.04, 0.04, 0.04), \n            title = \"Euclidean Distance: Allocation Layer for Fire Stations\", title.size = 1, \n            title.position = c(\"LEFT\", \"TOP\")) + \n  tm_scale_bar(breaks = seq(0, 20, 4), color.dark = \"gray60\", position = c(0.03, 0.01))\nmy_map\n```\n\n::: {.cell-output-display}\n![](raster_proximity_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n티센 폴리곤을 생성하여 비교해 본다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseoul_sobang |> \n  st_union() |> \n  st_voronoi(st_as_sfc(st_bbox(seoul))) |> \n  st_cast() |> \n  st_intersection(seoul) |> \n  st_as_sf() |> \n  st_cast(\"POLYGON\") -> seoul_sobang_thiessen\n\nseoul_sobang_thiessen |> \n  st_intersects(seoul_sobang) |> \n  unlist() -> sel_index\nseoul_sobang_thiessen |> \n  mutate(\n    ID = as.character(sel_index)\n  ) -> seoul_sobang_thiessen\n\n# seoul_sobang_thiessen$ID <- unlist(st_intersects(seoul_sobang_thiessen, seoul_sobang)) \n# seoul_sobang_thiessen <- aggregate(seoul_sobang_thiessen, by = list(seoul_sobang_thiessen$ID), FUN = sum)\n# seoul_sobang_thiessen$ID <- as.factor(seoul_sobang_thiessen$ID) \n```\n:::\n\n\n지도를 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(seoul) + tm_polygons(col = \"gray98\", border.col = \"gray30\") +\n  tm_shape(seoul_sobang_thiessen) + tm_polygons(col = \"ID\", palette = \"Set3\", lwd = 1, border.col = \"gray20\", legend.show = FALSE) +\n  tm_shape(seoul_sobang) + tm_symbols() +\n  tm_shape(seoul) + tm_borders(col = \"gray20\", lwd = 1.5) +\n  tm_legend(legend.position = c(0.85, 0.03), legend.bg.color = \"white\", legend.bg.alpha = 0.6) +\n  tm_layout(inner.margins = c(0.06, 0.04, 0.04, 0.04), \n            title = \"Thiessen Polygons for Fire Stations\", title.size = 1, \n            title.position = c(\"LEFT\", \"TOP\")) + \n  tm_scale_bar(breaks = seq(0, 20, 4), color.dark = \"gray60\", position = c(0.03, 0.01))\nmy_map\n```\n\n::: {.cell-output-display}\n![](raster_proximity_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n## 기능적 거리\n\n`movecost` 패키지를 사용한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# library(devtools)\n# install_github(\"cran/movecost\")\nlibrary(movecost)\n```\n:::\n\n\n### 거리\n\n`movecost()` 함수를 이용하여 기능적 거리를 계산한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# result_cost <- movecost(dem_seoul_mask, origin = as_Spatial(seoul_sobang), funct = \"wcs\")\n# seoul_sobang_cost <- result_cost$accumulated.cost.raster/1000\n# crs(seoul_sobang_cost) <- \"+proj=tmerc +lat_0=38 +lon_0=127.5 +k=0.9996 +x_0=1000000 +y_0=2000000 +ellps=GRS80 +units=m\"\n# writeRaster(seoul_sobang_cost, \"seoul_sobang_cost\", format=\"GTiff\", overwrite = TRUE)\nseoul_sobang_cost <- rast(\"seoul_sobang_cost.tif\")\n```\n:::\n\n\n지도를 제작한다. 먼저 연속형 컬러 스킴을 사용하여 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(seoul_sobang_cost, raster.downsample = FALSE) + tm_raster(style = \"cont\", palette = \"GnBu\", title = \"Least Cost\") +\n  tm_shape(seoul_sobang) + tm_symbols() +\n  tm_shape(seoul) + tm_borders(col = \"gray20\", lwd = 1.5) +\n  tm_legend(legend.position = c(0.85, 0.03), legend.bg.color = \"white\", legend.bg.alpha = 0.6) +\n  tm_layout(inner.margins = c(0.06, 0.04, 0.04, 0.04), \n            title = \"Functional Distance from Fire Stations\", title.size = 1, \n            title.position = c(\"LEFT\", \"TOP\")) + \n  tm_scale_bar(breaks = seq(0, 20, 4), color.dark = \"gray60\", position = c(0.03, 0.01))\nmy_map\n```\n\n::: {.cell-output-display}\n![](raster_proximity_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n이번에는 단계구분형 컬러 스킴을 사용하여 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(seoul_sobang_cost, raster.downsample = FALSE) + tm_raster(style = \"fixed\", breaks = c(0, 1, 2, 3, 4, 5, Inf), palette = \"GnBu\", title = \"Least Cost\") +\n  tm_shape(seoul_sobang) + tm_symbols() +\n  tm_shape(seoul) + tm_borders(col = \"gray20\", lwd = 1.5) +\n  tm_legend(legend.position = c(0.85, 0.03), legend.bg.color = \"white\", legend.bg.alpha = 0.6) +\n  tm_layout(inner.margins = c(0.06, 0.04, 0.04, 0.04), \n            title = \"Functional Distance from Fire Stations\", title.size = 1, \n            title.position = c(\"LEFT\", \"TOP\")) + \n  tm_scale_bar(breaks = seq(0, 20, 4), color.dark = \"gray60\", position = c(0.03, 0.01))\nmy_map\n```\n\n::: {.cell-output-display}\n![](raster_proximity_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n### 할당\n\n`movealloc()` 함수를 활용하여 할당 레이어를 계산한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# result_allo <- movealloc(dem_seoul_mask, as_Spatial(seoul_sobang), funct = \"wcs\")\n# seoul_sobang_allo_cost <- result_allo$cost.allocation.raster\n# crs(seoul_sobang_allo_cost) <- \"+proj=tmerc +lat_0=38 +lon_0=127.5 +k=0.9996 +x_0=1000000 +y_0=2000000 +ellps=GRS80 +units=m\"\n# writeRaster(seoul_sobang_allo_cost, \"seoul_sobang_allo_cost\", format=\"GTiff\", overwrite = TRUE)\nseoul_sobang_allo_cost <- rast(\"seoul_sobang_allo_cost.tif\")\n```\n:::\n\n\n지도를 제작한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_map <- tm_shape(seoul_sobang_allo_cost, raster.downsample = FALSE) + tm_raster(style = \"cat\", palette = \"Set3\", legend.show = FALSE) +\n  tm_shape(seoul_sobang) + tm_symbols() +\n  tm_shape(seoul) + tm_borders(col = \"gray20\", lwd = 1.5) +\n  tm_legend(legend.position = c(0.85, 0.03), legend.bg.color = \"white\", legend.bg.alpha = 0.6) +\n  tm_layout(inner.margins = c(0.06, 0.04, 0.04, 0.04), \n            title = \"Functional Distance: Allocation for Fire Stations\", title.size = 1, \n            title.position = c(\"LEFT\", \"TOP\")) + \n  tm_scale_bar(breaks = seq(0, 20, 4), color.dark = \"gray60\", position = c(0.03, 0.01))\nmy_map\n```\n\n::: {.cell-output-display}\n![](raster_proximity_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n### 또 다른 방법\n\n위의 예시와 달리 [`topoDistance`](https://cran.r-project.org/web/packages/topoDistance/vignettes/topoDistance-vignette.html) 패키지를 활용하여 거리면을 생성해 본다. 이 패키지는 DEM 상에서의 거리를 계산해 주는데, 일반적인 GIS 프로그램에 사용되는 지형 거리 혹은 표면 거리와 달리 일종의 최소비용경로 개념을 상정한다. 보통은 두 지점 사이의 직선 거리를 계산하되 DEM이 보여주는 지표면의 실질적인 굴곡을 감안하는 정도이지만(예를 들어 [`spatialEco`](https://jeffreyevans.github.io/spatialEco/) 패키지의 `top.distance()` 함수), `topoDistance` 패키지는 표면 거리를 최소화하는 경로를 설정하고 그 때의 표면 거리를 산출해준다. 그런데 문제는 topdDist() 함수는 오로지 포인트 벡터만 받아 그들 사이의 최소 지형 거리만을 산출해 준다는 것이다. 물론 apply 문을 이용해 계산을 할 수는 있으나 시간이 너무 많이 소요된다. 따라서 여기서는 소방서간 지형 거리를 산출하는 것만 해본다. 직선 거리와 비교해보면 지형 거리의 개념을 보다 명확히 할 수 있다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(topoDistance)\nlibrary(raster)\n\ndem_seoul_mask_r <- raster(dem_seoul_mask) # topoDist는 terra 형식은 받지 않고 raster 형식만 받음.\n\nseoul_sobang_coords <- seoul_sobang |> \n  st_coordinates() |> \n  as.matrix()\n\ndem_seoul_mask_r |> \n  topoDist(seoul_sobang_coords) -> sobang_topo_dist\nseoul_sobang |> \n  st_distance() -> sobang_eucl_dist\n```\n:::\n\n\n최소 지형 거리의 경로도 계산하고 그것을 지도화할 수도 있다. 그런데 시간이 너무 많이 걸리기 때문에 소방서 3개만 가지고 계산한다. 결과는 전혀 현실적이지 않다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseoul_sobang_coords_3 <- seoul_sobang |> \n  filter(\n    Name %in% c(\"강서소방서\", \"관악소방서\", \"송파소방서\")\n  ) |> \n  st_coordinates() |> \n  as.matrix()\n\ndem_seoul_mask_r |> \n  topoDist(seoul_sobang_coords_3, paths = TRUE) -> sobang_topo_dist_3\n\ntopoPathMap(dem_seoul_mask_r, seoul_sobang_coords_3, \n            topoPaths = sobang_topo_dist_3, type = \"hillshade\",\n            pathWidth = 4, cex = 2, bg = \"blue\")\n```\n\n::: {.cell-output-display}\n![](raster_proximity_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "raster_proximity_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}